```
# Project overview
Use this guide to build backend for the web app of emoji maker

# Tech stack
- We will use Next.js, Supabase, Clerk

# Tables & buckets already created
Supabase storage Bucket: "emojis"

TABLE emojis (
  id BIGINT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
  image_url TEXT NOT NULL,
  prompt TEXT NOT NULL,
  likes_count NUMERIC DEFAULT 0,
  creator_user_id TEXT NOT NULL,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

TABLE profiles (
  user_id TEXT PRIMARY KEY,
  credits INTEGER DEFAULT 3 NOT NULL,
  tier TEXT NOT NULL DEFAULT 'free' CHECK (tier IN ('free', 'pro')),
  stripe_customer_id TEXT,
  stripe_subscription_id TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP NOT NULL,
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP NOT NULL
);

TABLE emoji_likes (
  user_id TEXT REFERENCES profiles(user_id),
  emoji_id BIGINT REFERENCES emojis(id),
  PRIMARY KEY (user_id, emoji_id)
);

# functions in database to handle like/dislike status
CREATE OR REPLACE FUNCTION update_emoji_likes_count(emoji_id BIGINT)
RETURNS TABLE (likes_count BIGINT) AS $$
DECLARE
  new_count BIGINT;
BEGIN
  SELECT COUNT(*) INTO new_count
  FROM emoji_likes
  WHERE emoji_likes.emoji_id = $1;

  UPDATE emojis
  SET likes_count = new_count
  WHERE id = $1;

  RETURN QUERY SELECT new_count AS likes_count;
END;
$$ LANGUAGE plpgsql;

3 functions related to likes count
-- Function to increment likes_count
CREATE OR REPLACE FUNCTION increment_emoji_likes(emoji_id BIGINT)
RETURNS void AS $$
BEGIN
  UPDATE emojis
  SET likes_count = likes_count + 1
  WHERE id = emoji_id;
END;
$$ LANGUAGE plpgsql;

-- Function to decrement likes_count
CREATE OR REPLACE FUNCTION decrement_emoji_likes(emoji_id BIGINT)
RETURNS void AS $$
BEGIN
  UPDATE emojis
  SET likes_count = GREATEST(likes_count - 1, 0)
  WHERE id = emoji_id;
END;
$$ LANGUAGE plpgsql;

# Requirements
1. Create user to user table
   0. Clerk is already setup, dont need to worry about it
   1. After a user signin via clerk successfully, we should get the userId from clerk, and check if userId exist in 'profiles' table, matching "user_id" (Only do this if user signin successfully)
   2. if the user doesnt exist, then create a user in 'profiles' table
   3. if the user exist already, then proceed, and pass on user_id to functions like generate emojis

2. Upload emoji to "emojis" supabase storage bucket;
   1. When user generating an emoji, upload the emoji image file returned from Replicate to supabase "emojis" storage bucket
   2. Add a row to 'emojis' table where the image url to te "emojis" data table as "image_url", and creator_user_id to be the actual user_id
3. Display all images in emojigrid
   1. Emoji grid should fetch and display all images from "emojis" data table
   2. when a new emoji is generated, the emojigrid should be updated automatically to add the new emoji to the grid
4. Likes interaction
   1. When user check on 'like' button, the num_likes should increase on the 'emojis' table
   2. when user un-check 'like' button, the num_likes should decrease on the 'emojis' table


# Documentations
## Example of uploading files to supabase storage
import { createClient } from '@supabase/supabase-js'

// Create Supabase client
const supabase = createClient('your_project_url', 'your_supabase_api_key')

// Upload file using standard upload
async function uploadFile(file) {
  const { data, error } = await supabase.storage.from('bucket_name').upload('file_path', file)
  if (error) {
    // Handle error
  } else {
    // Handle success
  }
}
```
